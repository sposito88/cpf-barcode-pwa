<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner CPF/CNPJ - Otimizado para Documentos Oficiais</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366f1">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    
    <!-- Tesseract.js para OCR real -->
    <script src="https://unpkg.com/tesseract.js@v4.1.1/dist/tesseract.min.js"></script>
    <!-- JsBarcode para geração de códigos -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn-primary {
            background: #22c55e;
            color: white;
        }

        .btn-primary:hover {
            background: #16a34a;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #5b6470;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .camera-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #d1d5db;
            text-align: center;
        }

        .camera-section.active {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        #video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border-radius: 12px;
            background: #000;
            object-fit: cover;
        }

        .camera-controls {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .result-section {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }

        .result-section.success {
            background: #f0fdf4;
            border-color: #22c55e;
        }

        .result-section.error {
            background: #fef2f2;
            border-color: #ef4444;
        }

        .result-section h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }

        .result-section p {
            margin-bottom: 15px;
            color: #6b7280;
        }

        .tips {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .tips h4 {
            color: #92400e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tips ul {
            list-style: none;
            color: #92400e;
        }

        .tips li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .tips li:before {
            content: "•";
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.success {
            background: #22c55e;
        }

        .toast.error {
            background: #ef4444;
        }

        .toast.info {
            background: #3b82f6;
        }

        .toast.show {
            transform: translateX(0);
        }

        .ocr-progress {
            margin: 15px 0;
            padding: 15px;
            background: #f0f9ff;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .ocr-status {
            font-size: 14px;
            color: #1e40af;
            margin-top: 5px;
        }

        .tech-badge {
            display: inline-block;
            background: linear-gradient(45deg, #22c55e, #16a34a);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .detected-text {
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .file-upload {
            margin: 20px 0;
            padding: 20px;
            background: #f0f9ff;
            border: 2px dashed #3b82f6;
            border-radius: 12px;
            text-align: center;
        }

        .file-upload input[type="file"] {
            margin: 10px 0;
        }

        .camera-error {
            background: #fef2f2;
            border: 2px solid #ef4444;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .camera-error h4 {
            color: #dc2626;
            margin-bottom: 10px;
        }

        .camera-error p {
            color: #7f1d1d;
            margin-bottom: 15px;
        }

        .optimization-info {
            background: #f0fdf4;
            border: 2px solid #22c55e;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .optimization-info h4 {
            color: #16a34a;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .optimization-info ul {
            list-style: none;
            color: #166534;
        }

        .optimization-info li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .optimization-info li:before {
            content: "✅";
            position: absolute;
            left: 0;
        }

        @media (max-width: 480px) {
            .btn-group {
                grid-template-columns: 1fr;
            }
            
            .camera-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📱 Scanner CPF/CNPJ</h1>
            <p>Otimizado para Documentos Oficiais <span class="tech-badge">OCR Avançado</span></p>
        </div>

        <div class="content">
            <div class="optimization-info">
                <h4>🚀 Melhorias Implementadas:</h4>
                <ul>
                    <li>Pré-processamento avançado de imagem</li>
                    <li>Padrões flexíveis para documentos oficiais</li>
                    <li>Limpeza automática de texto OCR</li>
                    <li>Configuração otimizada para português BR</li>
                    <li>Múltiplas tentativas de reconhecimento</li>
                </ul>
            </div>

            <div class="form-group">
                <label for="document-input">Digite ou escaneie o documento:</label>
                <input type="text" id="document-input" placeholder="Ex: 123.456.789-00" maxlength="18">
            </div>

            <div class="form-group">
                <label for="document-type">Tipo de documento:</label>
                <select id="document-type">
                    <option value="cpf">CPF</option>
                    <option value="cnpj">CNPJ</option>
                </select>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="validateDocument()">✅ Validar</button>
                <button class="btn btn-secondary" onclick="startOCR()">🔍 Scanner OCR</button>
                <button class="btn btn-danger" onclick="clearForm()">🗑️ Limpar</button>
            </div>

            <!-- Seção de upload de arquivo -->
            <div id="file-upload-section" class="file-upload">
                <h4>📁 Upload de Documento Oficial:</h4>
                <input type="file" id="file-input" accept="image/*" onchange="processUploadedFile()">
                <p style="font-size: 14px; color: #6b7280; margin-top: 10px;">
                    Otimizado para: CPF, RG, CNH, Comprovantes da Receita Federal
                </p>
            </div>

            <!-- Seção da câmera -->
            <div id="camera-section" class="camera-section hidden">
                <video id="video" autoplay muted playsinline></video>
                <div class="camera-controls">
                    <button class="btn btn-primary" onclick="captureAndAnalyze()">📸 Capturar e Analisar</button>
                    <button class="btn btn-secondary" onclick="toggleFlash()">💡 Flash</button>
                    <button class="btn btn-danger" onclick="stopOCR()">❌ Fechar</button>
                </div>
                <p style="margin-top: 15px; color: #6b7280; font-size: 14px;">
                    Posicione o documento na tela e clique em "Capturar e Analisar"
                </p>
            </div>

            <!-- Erro de câmera -->
            <div id="camera-error" class="camera-error hidden">
                <h4>📷 Câmera não disponível</h4>
                <p>Não foi possível acessar a câmera do dispositivo.</p>
                <p><strong>Alternativas:</strong></p>
                <ul style="text-align: left; margin: 10px 0;">
                    <li>• Use o upload de arquivo acima</li>
                    <li>• Digite o CPF/CNPJ manualmente</li>
                    <li>• Verifique as permissões da câmera</li>
                </ul>
                <button class="btn btn-secondary" onclick="hideError()">OK, Entendi</button>
            </div>

            <!-- Progresso do OCR -->
            <div id="ocr-progress" class="ocr-progress hidden">
                <div>🔍 Analisando documento oficial...</div>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="ocr-status" class="ocr-status">Inicializando OCR otimizado...</div>
            </div>

            <!-- Texto detectado -->
            <div id="detected-text-section" class="hidden">
                <h4>📄 Texto Detectado (Bruto):</h4>
                <div id="detected-text" class="detected-text"></div>
                <h4>🔧 Texto Processado:</h4>
                <div id="processed-text" class="detected-text"></div>
            </div>

            <!-- Resultado -->
            <div id="result-section" class="result-section hidden">
                <!-- Resultado aparecerá aqui -->
            </div>

            <!-- Dicas -->
            <div class="tips">
                <h4>🤖 OCR Otimizado - Dicas para Documentos Oficiais:</h4>
                <ul>
                    <li><strong>Documentos Aceitos:</strong> CPF, RG, CNH, Comprovantes da Receita Federal</li>
                    <li><strong>Qualidade:</strong> Use imagens nítidas e bem iluminadas</li>
                    <li><strong>Enquadramento:</strong> Capture todo o documento, não apenas o número</li>
                    <li><strong>Formato:</strong> JPG, PNG ou WEBP em alta resolução</li>
                    <li><strong>Processamento:</strong> Aguarde o processamento completo (5-15 segundos)</li>
                    <li><strong>Múltiplas tentativas:</strong> Sistema tenta várias estratégias automaticamente</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let currentStream = null;
        let isProcessing = false;

        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', function() {
            showToast('Scanner OCR Otimizado carregado! Pronto para documentos oficiais', 'success');
            console.log('Tesseract.js carregado:', typeof Tesseract !== 'undefined');
        });

        // Função de toast
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Validação de CPF
        function validateCPF(cpf) {
            cpf = cpf.replace(/[^\d]/g, '');
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            
            let sum = 0;
            for (let i = 0; i < 9; i++) {
                sum += parseInt(cpf.charAt(i)) * (10 - i);
            }
            let remainder = 11 - (sum % 11);
            if (remainder === 10 || remainder === 11) remainder = 0;
            if (remainder !== parseInt(cpf.charAt(9))) return false;
            
            sum = 0;
            for (let i = 0; i < 10; i++) {
                sum += parseInt(cpf.charAt(i)) * (11 - i);
            }
            remainder = 11 - (sum % 11);
            if (remainder === 10 || remainder === 11) remainder = 0;
            return remainder === parseInt(cpf.charAt(10));
        }

        // Validação de CNPJ
        function validateCNPJ(cnpj) {
            cnpj = cnpj.replace(/[^\d]/g, '');
            if (cnpj.length !== 14) return false;
            
            const weights1 = [5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];
            const weights2 = [6, 5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];
            
            let sum = 0;
            for (let i = 0; i < 12; i++) {
                sum += parseInt(cnpj.charAt(i)) * weights1[i];
            }
            let remainder = sum % 11;
            const digit1 = remainder < 2 ? 0 : 11 - remainder;
            if (digit1 !== parseInt(cnpj.charAt(12))) return false;
            
            sum = 0;
            for (let i = 0; i < 13; i++) {
                sum += parseInt(cnpj.charAt(i)) * weights2[i];
            }
            remainder = sum % 11;
            const digit2 = remainder < 2 ? 0 : 11 - remainder;
            return digit2 === parseInt(cnpj.charAt(13));
        }

        // Formatação de documentos
        function formatDocument(value, type) {
            const numbers = value.replace(/[^\d]/g, '');
            if (type === 'cpf') {
                return numbers.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
            } else {
                return numbers.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
            }
        }

        // NOVA FUNÇÃO: Limpeza avançada de texto OCR
        function cleanOCRText(text) {
            console.log('Texto original:', text);
            
            // Múltiplas estratégias de limpeza
            let cleaned = text
                // Normalizar espaços
                .replace(/\s+/g, ' ')
                // Limpar pontos com espaços
                .replace(/\s*\.\s*/g, '.')
                // Limpar hífens com espaços
                .replace(/\s*-\s*/g, '-')
                // Remover caracteres especiais comuns em OCR
                .replace(/[^\d\.\-\s]/g, '')
                // Remover espaços extras no início e fim
                .trim();
            
            console.log('Texto limpo:', cleaned);
            return cleaned;
        }

        // NOVA FUNÇÃO: Pré-processamento de imagem
        function preprocessImage(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Aplicar filtro de contraste e binarização
            for (let i = 0; i < data.length; i += 4) {
                // Converter para escala de cinza
                const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                
                // Aplicar contraste
                const contrast = 1.5;
                const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
                const enhanced = factor * (gray - 128) + 128;
                
                // Binarização (preto e branco)
                const threshold = 128;
                const binary = enhanced > threshold ? 255 : 0;
                
                data[i] = binary;     // R
                data[i + 1] = binary; // G
                data[i + 2] = binary; // B
                // Alpha permanece o mesmo
            }
            
            ctx.putImageData(imageData, 0, 0);
            return canvas;
        }

        // NOVA FUNÇÃO: Extração avançada de documentos
        function extractDocumentsFromTextAdvanced(text) {
            const documents = [];
            
            console.log('Analisando texto para extração:', text);
            
            // Limpar texto primeiro
            const cleanedText = cleanOCRText(text);
            
            // Padrões mais flexíveis para CPF
            const flexibleCPFPatterns = [
                // Padrão com espaços irregulares: "147 .594.864-61"
                /\d{3}\s*\.?\s*\d{3}\s*\.?\s*\d{3}\s*-?\s*\d{2}/g,
                // Padrão normal: "147.594.864-61"
                /\b\d{3}\.?\d{3}\.?\d{3}-?\d{2}\b/g,
                // Apenas números: "14759486461"
                /\b\d{11}\b/g
            ];
            
            // Padrões mais flexíveis para CNPJ
            const flexibleCNPJPatterns = [
                // Com espaços irregulares
                /\d{2}\s*\.?\s*\d{3}\s*\.?\s*\d{3}\s*\/?\s*\d{4}\s*-?\s*\d{2}/g,
                // Padrão normal
                /\b\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2}\b/g,
                // Apenas números
                /\b\d{14}\b/g
            ];
            
            // Buscar CPFs com padrões flexíveis
            flexibleCPFPatterns.forEach((pattern, index) => {
                console.log(`Testando padrão CPF ${index + 1}:`, pattern);
                
                const matches = text.match(pattern);
                if (matches) {
                    console.log('Matches encontrados:', matches);
                    
                    matches.forEach(match => {
                        // Limpar match para validação
                        const cleanMatch = match.replace(/[^\d]/g, '');
                        console.log('Match limpo para validação:', cleanMatch);
                        
                        if (cleanMatch.length === 11 && validateCPF(cleanMatch)) {
                            console.log('CPF válido encontrado:', cleanMatch);
                            documents.push({
                                type: 'cpf',
                                value: match,
                                clean: cleanMatch,
                                formatted: formatDocument(cleanMatch, 'cpf')
                            });
                        }
                    });
                }
            });
            
            // Buscar CNPJs com padrões flexíveis
            flexibleCNPJPatterns.forEach((pattern, index) => {
                console.log(`Testando padrão CNPJ ${index + 1}:`, pattern);
                
                const matches = text.match(pattern);
                if (matches) {
                    console.log('Matches encontrados:', matches);
                    
                    matches.forEach(match => {
                        // Limpar match para validação
                        const cleanMatch = match.replace(/[^\d]/g, '');
                        console.log('Match limpo para validação:', cleanMatch);
                        
                        if (cleanMatch.length === 14 && validateCNPJ(cleanMatch)) {
                            console.log('CNPJ válido encontrado:', cleanMatch);
                            documents.push({
                                type: 'cnpj',
                                value: match,
                                clean: cleanMatch,
                                formatted: formatDocument(cleanMatch, 'cnpj')
                            });
                        }
                    });
                }
            });
            
            console.log('Documentos encontrados:', documents);
            return documents;
        }

        // Validar documento
        function validateDocument() {
            const input = document.getElementById('document-input');
            const type = document.getElementById('document-type').value;
            const value = input.value.trim();
            
            if (!value) {
                showToast('Por favor, digite um documento', 'error');
                return;
            }
            
            const formatted = formatDocument(value, type);
            input.value = formatted;
            
            const isValid = type === 'cpf' ? validateCPF(value) : validateCNPJ(value);
            
            const resultSection = document.getElementById('result-section');
            resultSection.className = `result-section ${isValid ? 'success' : 'error'}`;
            resultSection.innerHTML = `
                <h3>${isValid ? '✅' : '❌'} ${type.toUpperCase()}: ${isValid ? 'Válido' : 'Inválido'}</h3>
                <p><strong>Documento:</strong> ${formatted}</p>
                ${isValid ? generateBarcode(value, type) : ''}
            `;
            resultSection.classList.remove('hidden');
            
            showToast(`${type.toUpperCase()} ${isValid ? 'válido' : 'inválido'}!`, isValid ? 'success' : 'error');
        }

        // Gerar código de barras
        function generateBarcode(value, type) {
            const cleanValue = value.replace(/[^\d]/g, '');
            const canvasId = `barcode-${Date.now()}`;
            
            try {
                const html = `
                  <div style="margin-top: 20px; text-align: center; padding: 15px; background: #f8f9fa; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <h4 style="margin-bottom: 15px; color: #374151;">📊 Código de Barras</h4>
                    <div style="margin: 15px 0; display: flex; justify-content: center; align-items: center;">
                      <canvas id="${canvasId}" style="border: 1px solid #d1d5db; border-radius: 8px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></canvas>
                    </div>
                    <button class="btn btn-secondary" onclick="downloadBarcodeFromCanvas('${canvasId}', '${type}_${cleanValue}')" style="margin-top: 15px;">
                      💾 Download PNG
                    </button>
                  </div>
                `;
                
                setTimeout(() => {
                    const canvas = document.getElementById(canvasId);
                    if (canvas) {
                        try {
                            JsBarcode(canvas, cleanValue, {
                                format: 'CODE128',
                                width: 2,
                                height: 100,
                                displayValue: true,
                                fontSize: 16,
                                margin: 10,
                                background: '#ffffff',
                                lineColor: '#000000'
                            });
                            console.log('Código de barras renderizado para:', cleanValue);
                        } catch (renderError) {
                            console.error('Erro ao renderizar código de barras:', renderError);
                            canvas.style.display = 'none';
                            canvas.parentNode.innerHTML = '<p style="color: #ef4444;">Erro ao renderizar código de barras</p>';
                        }
                    }
                }, 100);
                
                return html;
            } catch (error) {
                console.error('Erro ao gerar código de barras:', error);
                return '<p style="color: #ef4444;">Erro ao gerar código de barras</p>';
            }
        }

        // Download do código de barras
        function downloadBarcodeFromCanvas(canvasId, filename) {
            const canvas = document.getElementById(canvasId);
            if (canvas) {
                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `${filename}.png`;
                link.href = dataUrl;
                link.click();
            } else {
                showToast('Erro: Canvas não encontrado', 'error');
            }
        }

        // Iniciar OCR (câmera ou upload)
        async function startOCR() {
            if (isProcessing) {
                showToast('OCR já está processando...', 'info');
                return;
            }

            // Tentar câmera primeiro
            try {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    await startCameraOCR();
                } else {
                    throw new Error('Câmera não suportada');
                }
            } catch (error) {
                console.error('Erro ao iniciar câmera:', error);
                showCameraError();
            }
        }

        // Iniciar OCR com câmera
        async function startCameraOCR() {
            try {
                const cameraSection = document.getElementById('camera-section');
                const video = document.getElementById('video');
                
                cameraSection.classList.remove('hidden');
                cameraSection.classList.add('active');
                
                // Configurações da câmera com fallbacks
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1920, min: 640 },
                        height: { ideal: 1080, min: 480 }
                    }
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                showToast('Câmera ativada! Posicione o documento e clique em Capturar', 'success');
                hideError();
                
            } catch (error) {
                console.error('Erro ao iniciar câmera:', error);
                showCameraError();
                throw error;
            }
        }

        // Mostrar erro de câmera
        function showCameraError() {
            const errorSection = document.getElementById('camera-error');
            errorSection.classList.remove('hidden');
            
            const cameraSection = document.getElementById('camera-section');
            cameraSection.classList.add('hidden');
            
            showToast('Câmera não disponível. Use upload de arquivo ou digite manualmente.', 'error');
        }

        // Esconder erro
        function hideError() {
            const errorSection = document.getElementById('camera-error');
            errorSection.classList.add('hidden');
        }

        // FUNÇÃO MELHORADA: Processar arquivo enviado
        async function processUploadedFile() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showToast('Por favor, selecione um arquivo de imagem', 'error');
                return;
            }
            
            if (isProcessing) {
                showToast('OCR já está processando...', 'info');
                return;
            }
            
            isProcessing = true;
            
            try {
                showOCRProgress();
                showToast('Processando documento oficial...', 'info');
                
                // Configuração otimizada para documentos oficiais
                const ocrConfig = {
                    logger: function(m) {
                        updateOCRProgress(m);
                    },
                    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
                    tessedit_char_whitelist: '0123456789.-/ ',
                    tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY,
                    preserve_interword_spaces: '1'
                };
                
                // Múltiplas tentativas com diferentes configurações
                let detectedText = '';
                let attempts = 0;
                const maxAttempts = 3;
                
                while (attempts < maxAttempts && !detectedText.trim()) {
                    attempts++;
                    console.log(`Tentativa ${attempts} de ${maxAttempts}`);
                    
                    updateOCRProgress({
                        status: `Tentativa ${attempts}/${maxAttempts}`,
                        progress: 0
                    });
                    
                    const result = await Tesseract.recognize(file, 'por', ocrConfig);
                    detectedText = result.data.text;
                    
                    if (!detectedText.trim() && attempts < maxAttempts) {
                        console.log('Tentativa falhou, tentando novamente...');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                console.log('Texto detectado final:', detectedText);
                
                // Mostrar texto detectado (bruto e processado)
                showDetectedText(detectedText);
                
                // Procurar por padrões de CPF/CNPJ com função avançada
                const foundDocuments = extractDocumentsFromTextAdvanced(detectedText);
                
                if (foundDocuments.length > 0) {
                    const doc = foundDocuments[0];
                    
                    // Preencher formulário
                    document.getElementById('document-input').value = doc.formatted;
                    document.getElementById('document-type').value = doc.type;
                    
                    showToast(`${doc.type.toUpperCase()} detectado: ${doc.formatted}`, 'success');
                    
                    // Validar automaticamente
                    setTimeout(() => validateDocument(), 500);
                } else {
                    showToast('Nenhum CPF/CNPJ válido encontrado na imagem', 'error');
                    
                    // Sugerir melhorias
                    showToast('Dica: Verifique se a imagem está nítida e bem iluminada', 'info');
                }
                
                hideOCRProgress();
                
            } catch (error) {
                console.error('Erro no OCR do arquivo:', error);
                showToast('Erro ao processar imagem. Tente uma imagem mais nítida.', 'error');
                hideOCRProgress();
            } finally {
                isProcessing = false;
                fileInput.value = ''; // Limpar input
            }
        }

        // FUNÇÃO MELHORADA: Capturar e analisar com câmera
        async function captureAndAnalyze() {
            if (isProcessing) {
                showToast('OCR já está processando...', 'info');
                return;
            }

            if (!currentStream) {
                showToast('Câmera não está ativa', 'error');
                return;
            }

            isProcessing = true;
            
            try {
                const video = document.getElementById('video');
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Capturar frame
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0);
                
                // Pré-processar imagem
                preprocessImage(canvas);
                
                // Mostrar progresso
                showOCRProgress();
                
                // Configuração otimizada
                const ocrConfig = {
                    logger: function(m) {
                        updateOCRProgress(m);
                    },
                    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
                    tessedit_char_whitelist: '0123456789.-/ ',
                    tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY,
                    preserve_interword_spaces: '1'
                };
                
                // Processar com Tesseract.js
                const result = await Tesseract.recognize(canvas, 'por', ocrConfig);
                const detectedText = result.data.text;
                
                console.log('Texto detectado da câmera:', detectedText);
                
                // Mostrar texto detectado
                showDetectedText(detectedText);
                
                // Procurar por padrões de CPF/CNPJ
                const foundDocuments = extractDocumentsFromTextAdvanced(detectedText);
                
                if (foundDocuments.length > 0) {
                    const doc = foundDocuments[0];
                    
                    // Preencher formulário
                    document.getElementById('document-input').value = doc.formatted;
                    document.getElementById('document-type').value = doc.type;
                    
                    showToast(`${doc.type.toUpperCase()} detectado: ${doc.formatted}`, 'success');
                    
                    // Validar automaticamente
                    setTimeout(() => validateDocument(), 500);
                } else {
                    showToast('Nenhum CPF/CNPJ encontrado no documento', 'error');
                }
                
                hideOCRProgress();
                
            } catch (error) {
                console.error('Erro no OCR da câmera:', error);
                showToast('Erro ao processar imagem', 'error');
                hideOCRProgress();
            } finally {
                isProcessing = false;
            }
        }

        // Mostrar progresso do OCR
        function showOCRProgress() {
            const progressSection = document.getElementById('ocr-progress');
            progressSection.classList.remove('hidden');
            
            const progressFill = document.getElementById('progress-fill');
            const statusText = document.getElementById('ocr-status');
            
            progressFill.style.width = '0%';
            statusText.textContent = 'Inicializando OCR otimizado...';
        }

        // Atualizar progresso do OCR
        function updateOCRProgress(m) {
            const progressFill = document.getElementById('progress-fill');
            const statusText = document.getElementById('ocr-status');
            
            if (m.status === 'recognizing text') {
                const progress = Math.round(m.progress * 100);
                progressFill.style.width = progress + '%';
                statusText.textContent = `Reconhecendo texto... ${progress}%`;
            } else {
                statusText.textContent = m.status;
            }
            
            console.log('OCR Progress:', m);
        }

        // Esconder progresso do OCR
        function hideOCRProgress() {
            const progressSection = document.getElementById('ocr-progress');
            progressSection.classList.add('hidden');
        }

        // FUNÇÃO MELHORADA: Mostrar texto detectado
        function showDetectedText(text) {
            const section = document.getElementById('detected-text-section');
            const textDiv = document.getElementById('detected-text');
            const processedDiv = document.getElementById('processed-text');
            
            // Mostrar texto bruto
            textDiv.textContent = text || 'Nenhum texto detectado';
            
            // Mostrar texto processado
            const cleanedText = cleanOCRText(text);
            processedDiv.textContent = cleanedText || 'Nenhum texto processado';
            
            section.classList.remove('hidden');
        }

        // Toggle flash (se disponível)
        function toggleFlash() {
            if (currentStream) {
                const track = currentStream.getVideoTracks()[0];
                const capabilities = track.getCapabilities();
                
                if (capabilities.torch) {
                    track.applyConstraints({
                        advanced: [{ torch: !track.getSettings().torch }]
                    }).then(() => {
                        showToast('Flash alternado', 'success');
                    }).catch(() => {
                        showToast('Flash não disponível', 'error');
                    });
                } else {
                    showToast('Flash não suportado neste dispositivo', 'error');
                }
            }
        }

        // Parar OCR
        function stopOCR() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            const cameraSection = document.getElementById('camera-section');
            cameraSection.classList.add('hidden');
            cameraSection.classList.remove('active');
            
            hideOCRProgress();
            hideError();
            
            showToast('Scanner fechado', 'success');
        }

        // Limpar formulário
        function clearForm() {
            document.getElementById('document-input').value = '';
            document.getElementById('result-section').classList.add('hidden');
            document.getElementById('detected-text-section').classList.add('hidden');
            document.getElementById('file-input').value = '';
            hideError();
            showToast('Formulário limpo', 'success');
        }

        // Formatação automática durante digitação
        document.getElementById('document-input').addEventListener('input', function(e) {
            const type = document.getElementById('document-type').value;
            const value = e.target.value.replace(/[^\d]/g, '');
            
            if (value.length > 0) {
                e.target.value = formatDocument(value, type);
            }
        });

        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('SW registrado'))
                .catch(err => console.log('Erro SW:', err));
        }
    </script>
</body>
</html>

