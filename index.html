<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Scanner de CPF ‚Üí C√≥digo de Barras</title>
  <meta name="theme-color" content="#0b1020">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <style>
    :root { --bg:#0b1020; --card:#121936; --accent:#6ee7ff; --ok:#22c55e; --bad:#ef4444; --txt:#e5e7eb; }
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#0b1020,#0b0f1a);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .title{display:flex;gap:12px;align-items:center;}
    .title h1{font-size:clamp(18px,3vw,28px);margin:0}
    .card{background:var(--card);border:1px solid #263157;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:14px}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:1.2fr .8fr}}
    video{width:100%;border-radius:14px;background:#000}
    canvas{display:none}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:600;cursor:pointer;background:#213055;color:#dbeafe;transition:.2s}
    button:hover{filter:brightness(1.1)}
    .primary{background:linear-gradient(135deg,#2563eb,#06b6d4);color:white}
    .ghost{background:#1a2747}
    input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #2b3a62;background:#0f142b;color:#e5e7eb}
    label{font-size:12px;opacity:.9}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #2a365f;background:#0f1732}
    .ok{color:var(--ok);border-color:#1b6e3b;background:#0b2b18}
    .bad{color:var(--bad);border-color:#6e1b1b;background:#2b0b0b}
    .muted{opacity:.8}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .barcode-wrap{display:grid;place-content:center;background:#0b0f1c;border-radius:12px;padding:14px;border:1px dashed #263157}
    svg{max-width:100%}
    .foot{opacity:.7;font-size:12px;margin-top:12px}
    .progress{height:10px;background:#0f1a35;border-radius:999px;overflow:hidden;border:1px solid #203158}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,#1f8ffd,#22d3ee);width:0}
    .hint{font-size:12px;opacity:.85}
    
    /* Melhorias para PWA */
    .install-prompt{position:fixed;top:16px;right:16px;background:var(--card);border:1px solid #263157;border-radius:12px;padding:12px;box-shadow:0 4px 20px rgba(0,0,0,.3);z-index:1000;max-width:300px;display:none}
    .install-prompt.show{display:block}
    .install-prompt button{margin-top:8px;width:100%}
    .install-prompt .close{position:absolute;top:8px;right:8px;background:none;border:none;color:var(--txt);font-size:18px;cursor:pointer;padding:4px}
    
    /* Melhorias para c√¢mera */
    .camera-container{position:relative}
    .focus-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:200px;height:80px;border:2px solid var(--accent);border-radius:8px;pointer-events:none;opacity:0.7;display:none}
    .focus-indicator.active{display:block}
    
    /* Melhorias para feedback */
    .status-message{background:var(--card);border-radius:8px;padding:8px 12px;margin-top:8px;border-left:3px solid var(--accent)}
    .status-message.error{border-left-color:var(--bad)}
    .status-message.success{border-left-color:var(--ok)}
  </style>
  <!-- libs via CDN -->
  <script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</head>
<body>
  <!-- Prompt de instala√ß√£o PWA -->
  <div id="installPrompt" class="install-prompt">
    <button class="close" onclick="hideInstallPrompt()">√ó</button>
    <div>üì± Instalar app no dispositivo?</div>
    <button id="installBtn" class="primary">Instalar</button>
    <button onclick="hideInstallPrompt()" class="ghost">Agora n√£o</button>
  </div>

  <div class="wrap">
    <div class="title">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 4H4a1 1 0 0 0-1 1v3M17 4h3a1 1 0 0 1 1 1v3M7 20H4a1 1 0 0 1-1-1v-3M17 20h3a1 1 0 0 0 1-1v-3" stroke="#6ee7ff" stroke-width="1.5" stroke-linecap="round"/><rect x="6" y="7" width="12" height="10" rx="2" stroke="#6ee7ff" stroke-width="1.5"/></svg>
      <h1>Scanner de CPF ‚Üí C√≥digo de Barras</h1>
    </div>

    <div class="grid">
      <!-- Lado esquerdo: c√¢mera e OCR -->
      <div class="card">
        <div class="row">
          <button id="btnStart" class="primary">üì∑ Ligar c√¢mera</button>
          <button id="btnShot" class="ghost" disabled>üñºÔ∏è Capturar & Ler CPF</button>
          <button id="btnStop" class="ghost" disabled>‚èπÔ∏è Desligar c√¢mera</button>
        </div>
        <div class="hint">Dica: aponte para um documento ou texto que contenha o CPF. Boa luz ajuda o OCR.</div>
        <div class="camera-container">
          <video id="video" playsinline muted></video>
          <div id="focusIndicator" class="focus-indicator"></div>
        </div>
        <canvas id="frame"></canvas>
        <div class="row" style="margin-top:8px">
          <div class="progress" style="flex:1"><i id="pbar"></i></div>
          <span id="status" class="badge muted">Aguardando‚Ä¶</span>
        </div>
        <div id="statusMessage" class="status-message" style="display:none"></div>
      </div>

      <!-- Lado direito: resultado, valida√ß√£o e barcode -->
      <div class="card">
        <div class="row">
          <div style="flex:1">
            <label for="cpf">CPF detectado (edite se necess√°rio)</label>
            <input id="cpf" inputmode="numeric" placeholder="___.___.___-__" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="btnValidate" class="primary">‚úÖ Validar & Gerar C√≥digo</button>
          </div>
        </div>
        <div class="row">
          <span id="validBadge" class="badge muted">CPF n√£o verificado</span>
          <select id="symbology" title="Tipo de c√≥digo de barras">
            <option value="CODE128" selected>CODE128 (recomendado)</option>
            <option value="ITF">Interleaved 2 of 5</option>
            <option value="MSI">MSI</option>
          </select>
          <button id="btnDownload" class="ghost" disabled>‚¨áÔ∏è Baixar c√≥digo de barras (PNG)</button>
        </div>
        <div class="barcode-wrap" style="margin-top:8px">
          <svg id="barcode"></svg>
        </div>
        <div class="foot">Privacidade: todo o processamento ocorre no seu dispositivo. Nenhum dado √© enviado a servidores.</div>
      </div>
    </div>

    <p class="foot">Observa√ß√£o: o CPF possui 11 d√≠gitos e dois d√≠gitos verificadores. O app valida a sequ√™ncia e remove formata√ß√µes. Se o OCR errar algum d√≠gito, toque no campo e corrija antes de gerar o c√≥digo.</p>
  </div>

<script>
  // ==== PWA Install Prompt ====
  let deferredPrompt;
  const installPrompt = document.getElementById('installPrompt');
  const installBtn = document.getElementById('installBtn');

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installPrompt.classList.add('show');
  });

  installBtn.addEventListener('click', async () => {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      if (outcome === 'accepted') {
        console.log('PWA instalado com sucesso');
      }
      deferredPrompt = null;
      hideInstallPrompt();
    }
  });

  function hideInstallPrompt() {
    installPrompt.classList.remove('show');
  }

  // ==== Utilidades CPF ====
  function onlyDigits(s){ return (s||'').replace(/\D+/g,''); }
  function formatCPF(d){ d = onlyDigits(d).slice(0,11); if(d.length<11) return d; return d.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4'); }
  function isSeq(d){ return /^([0-9])\1{10}$/.test(d); }
  function cpfCheckDigits(numbers){
    const calc = (base, factor) => {
      let sum = 0; for(let i=0;i<base.length;i++){ sum += parseInt(base[i],10) * (factor - i); }
      const rest = (sum * 10) % 11; return (rest===10||rest===11)?0:rest;
    };
    const n = onlyDigits(numbers);
    if(n.length!==11 || isSeq(n)) return false;
    const d1 = calc(n.slice(0,9), 10);
    const d2 = calc(n.slice(0,10), 11);
    return d1 === parseInt(n[9],10) && d2 === parseInt(n[10],10);
  }

  // ==== C√¢mera com foco autom√°tico ====
  const video = document.getElementById('video');
  const canvas = document.getElementById('frame');
  const btnStart = document.getElementById('btnStart');
  const btnShot  = document.getElementById('btnShot');
  const btnStop  = document.getElementById('btnStop');
  const statusEl = document.getElementById('status');
  const pbar     = document.getElementById('pbar');
  const focusIndicator = document.getElementById('focusIndicator');
  const statusMessage = document.getElementById('statusMessage');

  let stream;
  async function startCamera(){
    try{
      // Configura√ß√£o melhorada da c√¢mera com foco autom√°tico
      const constraints = {
        video: {
          facingMode: { ideal: 'environment' },
          width: { ideal: 1920 },
          height: { ideal: 1080 },
          focusMode: { ideal: 'continuous' },
          exposureMode: { ideal: 'continuous' },
          whiteBalanceMode: { ideal: 'continuous' }
        },
        audio: false
      };

      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      
      // Aguarda o v√≠deo carregar
      await new Promise((resolve) => {
        video.onloadedmetadata = resolve;
      });
      
      await video.play();
      
      // Mostra indicador de foco
      focusIndicator.classList.add('active');
      
      btnShot.disabled = false;
      btnStop.disabled = false;
      btnStart.disabled = true;
      
      setStatus('C√¢mera ligada. Aponte para o CPF e toque em "Capturar & Ler"');
      showStatusMessage('C√¢mera ativada com foco autom√°tico. Posicione o documento na √°rea destacada.', 'success');
      
      // Auto-foco quando o usu√°rio toca na tela
      video.addEventListener('click', () => {
        if (stream && stream.getVideoTracks().length > 0) {
          const track = stream.getVideoTracks()[0];
          if (track.getCapabilities && track.getCapabilities().focusMode) {
            track.applyConstraints({
              advanced: [{ focusMode: 'manual', focusDistance: 0 }]
            }).then(() => {
              setTimeout(() => {
                track.applyConstraints({
                  advanced: [{ focusMode: 'continuous' }]
                });
              }, 100);
            }).catch(console.error);
          }
        }
      });
      
    }catch(e){
      console.error('Erro na c√¢mera:', e);
      showStatusMessage('Erro ao acessar c√¢mera: ' + e.message, 'error');
      alert('N√£o foi poss√≠vel acessar a c√¢mera: '+ e.message);
    }
  }
  
  function stopCamera(){
    if(stream){
      stream.getTracks().forEach(t => t.stop());
    }
    focusIndicator.classList.remove('active');
    btnStart.disabled = false;
    btnShot.disabled = true;
    btnStop.disabled = true;
    setStatus('C√¢mera desligada');
    hideStatusMessage();
  }

  btnStart.onclick = startCamera;
  btnStop.onclick = stopCamera;

  // ==== OCR melhorado com Tesseract ====
  async function grabAndOcr(){
    if(!video.srcObject) return;
    
    const w = video.videoWidth;
    const h = video.videoHeight;
    canvas.width = w;
    canvas.height = h;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);
    
    // Melhora a imagem antes do OCR
    const imageData = ctx.getImageData(0, 0, w, h);
    const data = imageData.data;
    
    // Aplica filtros para melhorar o reconhecimento
    for (let i = 0; i < data.length; i += 4) {
      const gray = (data[i] + data[i + 1] + data[i + 2]) / 3;
      const threshold = 128;
      const binary = gray > threshold ? 255 : 0;
      data[i] = data[i + 1] = data[i + 2] = binary;
    }
    
    ctx.putImageData(imageData, 0, 0);
    const dataUrl = canvas.toDataURL('image/png');

    setStatus('Lendo imagem‚Ä¶');
    setProgress(5);
    showStatusMessage('Processando imagem com OCR...', 'success');
    
    try {
      const worker = await Tesseract.createWorker({
        logger: m => {
          if(m.status && m.progress != null){
            setStatus(m.status);
            setProgress(Math.round(m.progress * 100));
          }
        }
      });
      
      await worker.load();
      await worker.loadLanguage('por');
      await worker.initialize('por');
      
      // Configura√ß√µes espec√≠ficas para melhorar reconhecimento de n√∫meros
      await worker.setParameters({
        tessedit_char_whitelist: '0123456789.-',
        tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
        preserve_interword_spaces: '1'
      });
      
      const { data: { text } } = await worker.recognize(dataUrl);
      await worker.terminate();

      const candidates = extractCpfCandidates(text);
      
      if(candidates.length > 0){
        // Prioriza CPFs v√°lidos
        const validFirst = candidates.sort((a,b) => {
          const aValid = cpfCheckDigits(a);
          const bValid = cpfCheckDigits(b);
          if (aValid && !bValid) return -1;
          if (!aValid && bValid) return 1;
          return 0;
        });
        
        const picked = validFirst[0];
        setCPF(picked);
        
        if (cpfCheckDigits(picked)) {
          setStatus('CPF v√°lido detectado! Revise e gere o c√≥digo.');
          showStatusMessage('CPF v√°lido encontrado: ' + formatCPF(picked), 'success');
        } else {
          setStatus('CPF detectado (pode precisar de corre√ß√£o).');
          showStatusMessage('CPF detectado, mas verifique se est√° correto: ' + formatCPF(picked), 'error');
        }
      } else {
        setStatus('N√£o encontrei um CPF claro. Tente aproximar, melhorar a luz ou digitar manualmente.');
        showStatusMessage('Nenhum CPF encontrado na imagem. Tente melhorar o foco ou a ilumina√ß√£o.', 'error');
      }
      
    } catch (error) {
      console.error('Erro no OCR:', error);
      setStatus('Erro ao processar imagem');
      showStatusMessage('Erro no processamento OCR: ' + error.message, 'error');
    }
    
    setProgress(0);
  }

  function extractCpfCandidates(text){
    console.log('Texto extra√≠do:', text);
    
    // Limpa o texto
    const cleanText = (text || '').replace(/[Oo]/g, '0').replace(/[lI]/g, '1');
    
    // Padr√µes para CPF
    const patterns = [
      // CPF com formata√ß√£o: 123.456.789-01
      /\b\d{3}[\.\s]?\d{3}[\.\s]?\d{3}[-\s]?\d{2}\b/g,
      // CPF sem formata√ß√£o: 12345678901
      /\b\d{11}\b/g,
      // CPF parcial com formata√ß√£o
      /\b\d{3}[\.\s]?\d{3}[\.\s]?\d{3}\b/g
    ];
    
    const candidates = new Set();
    
    patterns.forEach(pattern => {
      const matches = cleanText.match(pattern) || [];
      matches.forEach(match => {
        const digits = onlyDigits(match);
        if (digits.length === 11) {
          candidates.add(digits);
        }
      });
    });
    
    // Busca por sequ√™ncias de 11 d√≠gitos consecutivos
    const allDigits = cleanText.match(/\d/g)?.join('') || '';
    for (let i = 0; i + 11 <= allDigits.length; i++) {
      const seq = allDigits.slice(i, i + 11);
      if (seq.length === 11) {
        candidates.add(seq);
      }
    }
    
    const result = Array.from(candidates).filter(s => s.length === 11);
    console.log('Candidatos encontrados:', result);
    return result;
  }

  function setStatus(msg){ statusEl.textContent = msg; }
  function setProgress(v){ pbar.style.width = Math.max(0, Math.min(100, v)) + '%'; }
  
  function showStatusMessage(message, type = 'success') {
    statusMessage.textContent = message;
    statusMessage.className = `status-message ${type}`;
    statusMessage.style.display = 'block';
  }
  
  function hideStatusMessage() {
    statusMessage.style.display = 'none';
  }

  const btnOcr = document.getElementById('btnShot');
  btnOcr.onclick = grabAndOcr;

  // ==== Campo CPF, valida√ß√£o e barcode ====
  const cpfInput = document.getElementById('cpf');
  const badge = document.getElementById('validBadge');
  const btnValidate = document.getElementById('btnValidate');
  const symSel = document.getElementById('symbology');

  function setCPF(v){ cpfInput.value = formatCPF(v); }
  cpfInput.addEventListener('input', ()=> { 
    cpfInput.value = formatCPF(cpfInput.value); 
    badge.className='badge muted'; 
    badge.textContent='CPF n√£o verificado'; 
  });

  function markValid(ok){
    if(ok){ 
      badge.className='badge ok'; 
      badge.textContent='CPF v√°lido'; 
    } else { 
      badge.className='badge bad'; 
      badge.textContent='CPF inv√°lido'; 
    }
  }

  function generateBarcode(){
    const val = onlyDigits(cpfInput.value);
    const type = symSel.value;
    
    if(!val || val.length !== 11){
      markValid(false);
      showStatusMessage('Informe um CPF com 11 d√≠gitos.', 'error');
      return;
    }
    
    const ok = cpfCheckDigits(val);
    markValid(ok);
    
    if(!ok){
      showStatusMessage('CPF inv√°lido pelo c√°lculo dos d√≠gitos verificadores. Corrija antes de gerar.', 'error');
      return;
    }
    
    try{
      JsBarcode('#barcode', val, { 
        format: type, 
        displayValue: true, 
        fontSize: 16, 
        margin: 10,
        background: '#ffffff',
        lineColor: '#000000'
      });
      document.getElementById('btnDownload').disabled = false;
      showStatusMessage('C√≥digo de barras gerado com sucesso!', 'success');
    }catch(e){
      showStatusMessage('Erro ao gerar c√≥digo: ' + e.message, 'error');
    }
  }

  btnValidate.onclick = generateBarcode;

  // ==== Download do SVG como PNG ====
  const btnDownload = document.getElementById('btnDownload');
  btnDownload.onclick = () => {
    const svg = document.getElementById('barcode');
    const xml = new XMLSerializer().serializeToString(svg);
    const svg64 = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(xml);
    const img = new Image();
    img.onload = () => {
      const c = document.createElement('canvas');
      c.width = img.width * 2; // Aumenta a resolu√ß√£o
      c.height = img.height * 2;
      const ctx = c.getContext('2d');
      ctx.scale(2, 2); // Escala para melhor qualidade
      ctx.drawImage(img, 0, 0);
      const link = document.createElement('a');
      link.download = `barcode_cpf_${onlyDigits(cpfInput.value)}.png`;
      link.href = c.toDataURL('image/png');
      link.click();
      showStatusMessage('C√≥digo de barras baixado com sucesso!', 'success');
    };
    img.src = svg64;
  };

  // ==== Service Worker registration ====
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(registration => {
          console.log('SW registrado:', registration);
        })
        .catch(error => {
          console.error('Erro no SW:', error);
        });
    });
  }
</script>
</body>
</html>
